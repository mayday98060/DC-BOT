name: Frequent MySQL Backup
on:
  schedule:
    - cron: "*/5 * * * *"  # æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼ˆå¦‚æœè¦æ¯ 2 å°æ™‚æ”¹æˆ 0 */2 * * *ï¼‰

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: å–å¾—å°ˆæ¡ˆ
        uses: actions/checkout@v2

      - name: è¨­å®šç’°å¢ƒè®Šæ•¸
        env:
          MYSQL_URL: ${{ secrets.MYSQL_URL }}
        run: echo "âœ… Using MYSQL_URL from GitHub Secrets"

      - name: å®‰è£ MySQL å®¢æˆ¶ç«¯
        run: sudo apt-get update && sudo apt-get install -y mysql-client

      - name: åŸ·è¡Œ MySQL å‚™ä»½
        env:
          MYSQL_URL: ${{ secrets.MYSQL_URL }}
        run: |
          set -e  # å¦‚æœæœ‰éŒ¯èª¤ï¼Œç«‹å³åœæ­¢
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

          # è§£æ MySQL URL
          MYSQL_HOST=$(echo "$MYSQL_URL" | sed -E 's#mysql://[^@]+@([^:/]+).*#\1#')
          MYSQL_PORT=$(echo "$MYSQL_URL" | sed -E 's#mysql://[^@]+@[^:/]+:([0-9]+).*#\1#')
          MYSQL_USER=$(echo "$MYSQL_URL" | sed -E 's#mysql://([^:]+):.*#\1#')
          MYSQL_PASSWORD=$(echo "$MYSQL_URL" | sed -E 's#mysql://[^:]+:([^@]+)@.*#\1#')
          MYSQL_DATABASE=$(echo "$MYSQL_URL" | sed -E 's#.*/([^/?]+).*#\1#')

          echo "ğŸ”„ é€£ç·šè³‡è¨Š: Host=$MYSQL_HOST, Port=$MYSQL_PORT, User=$MYSQL_USER, Database=$MYSQL_DATABASE"

          # åŸ·è¡Œ mysqldump å‚™ä»½
          mysqldump --column-statistics=0 --single-transaction --quick --lock-tables=false \
            -h "$MYSQL_HOST" -P "$MYSQL_PORT" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" "$MYSQL_DATABASE" > backup_$TIMESTAMP.sql

          echo "âœ… MySQL å‚™ä»½æˆåŠŸï¼"

      - name: æ¨é€åˆ° GitHub
        run: |
          set -x  # å•Ÿç”¨è©³ç´°æ¨¡å¼
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # ç¢ºä¿æœ‰å‚™ä»½æª”æ¡ˆ
          if [ -n "$(git ls-files --others --exclude-standard backup_*.sql)" ]; then
            git add backup_*.sql
            git commit -m "ğŸ”„ Auto Backup: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          else
            echo "âš ï¸ æ²’æœ‰æ–°çš„å‚™ä»½æª”æ¡ˆå¯æäº¤"
          fi
